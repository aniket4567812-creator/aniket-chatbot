const http = require("http");

const port = process.env.PORT || 8080;

let lastMessage = "Hi! I'm your AI chatbot, made by Aniket. How can I help you today?";

const server = http.createServer((req, res) => {
  if (req.method === "POST" && req.url === "/chatbot") {
    let body = "";
    req.on("data", chunk => {
      body += chunk.toString();
    });
    req.on("end", () => {
      const userMessage = JSON.parse(body).message;
      // Simple AI reply logic (basically echo)
      const replyMessage = `You said: "${userMessage}". Made by Aniket!`;
      lastMessage = replyMessage;

      res.writeHead(200, { "Content-Type": "application/json" });
      res.end(JSON.stringify({ reply: replyMessage }));
    });
  } else if (req.url === "/") {
    res.writeHead(200, { "Content-Type": "text/html" });
    res.end(`
      <html>
      <head>
        <title>Aniket's AI Chatbot</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 30px; background: #121212; color: #eee; }
          #chatbox { width: 400px; height: 300px; border: 1px solid #555; padding: 10px; overflow-y: scroll; background: #222; }
          #inputBox { width: 350px; padding: 10px; margin-top: 10px; }
          button { padding: 10px; }
          .message { margin: 5px 0; }
          .user { color: #6cf; }
          .bot { color: #fc6; }
        </style>
      </head>
      <body>
        <h1>Aniket's AI Chatbot</h1>
        <div id="chatbox"></div>
        <input type="text" id="inputBox" placeholder="Type your message..." />
        <button onclick="sendMessage()">Send</button>

        <script>
          const chatbox = document.getElementById('chatbox');
          const inputBox = document.getElementById('inputBox');

          function addMessage(text, sender) {
            const div = document.createElement('div');
            div.textContent = text;
            div.classList.add('message');
            div.classList.add(sender);
            chatbox.appendChild(div);
            chatbox.scrollTop = chatbox.scrollHeight;
          }

          function sendMessage() {
            const message = inputBox.value.trim();
            if (!message) return;
            addMessage('You: ' + message, 'user');
            inputBox.value = '';

            fetch('/chatbot', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message })
            })
            .then(res => res.json())
            .then(data => {
              addMessage('Bot: ' + data.reply, 'bot');
            })
            .catch(() => addMessage('Bot: Error contacting server.', 'bot'));
          }

          // Welcome message
          addMessage('Bot: Hi! I\'m your AI chatbot, made by Aniket. How can I help you today?', 'bot');

          inputBox.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
              sendMessage();
            }
          });
        </script>
      </body>
      </html>
    `);
  } else {
    res.writeHead(404);
    res.end("Not Found");
  }
});

server.listen(port, () => {
  console.log(`Server running at http://localhost:${port}/`);
});
